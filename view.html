<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirador Viewer</title>
    <script src="https://unpkg.com/mirador@latest/dist/mirador.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #viewer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
        }

        /* Force pointer events on annotation containers and links */
        #viewer a,
        #viewer .mirador-third-party-html,
        #viewer .mirador-third-party-html * {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
    </style>
</head>
<body>
<!-- byte-conform copy of:  https://viewer-f044f0.pages.mpcdf.de -->
<div id="viewer"></div>

<script type="text/javascript">
    var urlParams = new URLSearchParams(window.location.search);
    var manifestUrl = urlParams.get('manifest');
    var itemParam = urlParams.get('item');
    var canvasParam = urlParams.get('canvas');
    var viewParam = urlParams.get('view');

    // ONLY for testing, comment for production!
    // itemParam = 'ab816400078'
    
    // Build manifest URL from item parameter if manifest not provided
    // Beware the manifest2 fixed string - this should be changed in the future.
    if (!manifestUrl && itemParam) {
        manifestUrl = 'https://dlib.biblhertz.it/iiif/' + itemParam + '/manifest2.json';
    }

    if (!manifestUrl) {
        document.body.innerHTML = '<h1>Error: No manifest or item provided</h1>';
    } else {
        var windowConfig = {
            loadedManifest: manifestUrl
        };

        // Construct canvas ID if canvas parameter provided
        if (canvasParam) {
            // Extract object ID from manifest URL (e.g., dm5055800)
            var objectMatch = manifestUrl.match(/iiif\/(?:2\/)?([^\/]+)\//);
            if (objectMatch) {
                var objectId = objectMatch[1];
                var paddedCanvas = canvasParam.toString().padStart(4, '0');
                var canvasId = 'https://dlib2.biblhertz.it/iiif/2/' + objectId + '@' + paddedCanvas + '-canvas';
                windowConfig.canvasId = canvasId;
            }
        }

        // Determine sidebar configuration from view parameter
        var sideBarOpen = true;
        var sideBarPanel = 'info'; // default

        if (viewParam) {
            // Valid panels: info, attribution, annotations, canvas
            var validPanels = ['info', 'attribution', 'annotations', 'canvas'];
            if (viewParam === 'none' || viewParam === 'closed') {
                sideBarOpen = false;
            } else if (validPanels.indexOf(viewParam) !== -1) {
                sideBarPanel = viewParam;
            }
        }

        var mirador = Mirador.viewer({
            id: "viewer",
            windows: [windowConfig],
            thumbnailNavigation: {
                defaultPosition: 'far-right'
            },
            workspaceControlPanel: {
                enabled: false,
            },
            window: {
                sideBarOpen: sideBarOpen,
                sideBarPanel: sideBarPanel,
                defaultSidebarPanelWidth: 350,
                allowClose: false,
                allowMaximize: false,
                allowFullscreen: true,
                allowTopMenuButton: true,
                allowWindowSideBar: true,
                panels: {
                    info: true,
                    attribution: true,
                    annotations: true,
                    canvas: true,
                    search: false,
                    layers: false,
                },
                thumbnailNavigation: {
                    height: 130,
                    width: 100
                }
            },
            requests: {
                preprocessors: []
            },
            "osdConfig": {
                "showNavigator": true
            },
            "workspace": {
                "showZoomControls": true
            },
            "windowOptions": {
                "imageToolsEnabled": true,
                "imageToolsOpen": false
            },
            themes: {
                dark: {
                    palette: {
                        type: 'dark',
                        primary: {
                            main: '#8E1B15',
                        },
                        secondary: {
                            main: '#8E1B15',
                        }
                    }
                },
                light: {
                    palette: {
                        type: 'light',
                        primary: {
                            main: '#8E1B15',
                        },
                        secondary: {
                            main: '#8E1B15',
                        }
                    }
                },
            },
        });

        // Define store FIRST
        var store = mirador.store;

        var lastViewport = null;
        var viewportUpdateTimeout;

        store.subscribe(function() {
            var state = store.getState();
            var windowIds = Object.keys(state.windows);

            if (windowIds.length > 0) {
                var windowId = windowIds[0];
                var viewerState = state.viewers[windowId];

                if (viewerState) {
                    var currentViewport = viewerState.x + ',' + viewerState.y + ',' + viewerState.zoom;

                    // Only update if viewport actually changed
                    if (currentViewport !== lastViewport) {
                        lastViewport = currentViewport;

                        clearTimeout(viewportUpdateTimeout);
                        viewportUpdateTimeout = setTimeout(function() {
                            var newUrlParams = new URLSearchParams(window.location.search);
                            newUrlParams.set('x', '' + Math.round(Number(viewerState.x)));
                            newUrlParams.set('y', '' + Math.round(Number(viewerState.y)));
                            newUrlParams.set('z', (Number(viewerState.zoom) * 1000).toFixed(3)); // multiply by 1000

                            var newUrl = window.location.pathname + '?' + newUrlParams.toString();
                            window.history.replaceState(null, '', newUrl);
                        }, 500);
                    }
                }
            }
        });

// To restore viewport on load, dispatch an action to Mirador
        setTimeout(function() {
            var x = urlParams.get('x');
            var y = urlParams.get('y');
            var zoom = urlParams.get('z');

            if (x && y && zoom) {
                var windowIds = Object.keys(store.getState().windows);
                if (windowIds.length > 0) {
                    store.dispatch({
                        type: 'mirador/UPDATE_VIEWPORT',
                        windowId: windowIds[0],
                        payload: {
                            x: parseFloat(x),
                            y: parseFloat(y),
                            zoom: parseFloat(zoom) / 1000  // divide by 1000
                        }
                    });
                }
            }
        }, 1000);
        
        // Listen for canvas changes and update URL
        var currentCanvasId = null;
        store.subscribe(function () {
            var state = store.getState();
            var windowIds = Object.keys(state.windows);

            if (windowIds.length > 0) {
                var firstWindowId = windowIds[0];
                var canvasId = state.windows[firstWindowId].canvasId;

                if (canvasId && canvasId !== currentCanvasId) {
                    currentCanvasId = canvasId;

                    var canvasMatch = canvasId.match(/@(\d+)-canvas/);
                    if (canvasMatch) {
                        var canvasNumber = parseInt(canvasMatch[1], 10);

                        var newUrlParams = new URLSearchParams(window.location.search);
                        newUrlParams.set('canvas', canvasNumber);

                        var newUrl = window.location.pathname + '?' + newUrlParams.toString();
                        window.history.pushState(null, '', newUrl);
                    }
                }
            }
        });

        // Add custom download button
        var downloadButton = document.createElement('button');
        downloadButton.innerHTML = 'â¬‡';
        downloadButton.style.cssText =
            'position: fixed; bottom: 25px; right: 160px; z-index: 9999; padding: 10px 15px; background: #8E1B15; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Roboto, sans-serif; font-size: 14px; display: none;';

        downloadButton.addEventListener('click', function() {
            var state = store.getState();
            var windowIds = Object.keys(state.windows);
            if (windowIds.length > 0) {
                var canvasId = state.windows[windowIds[0]].canvasId;
                var canvasMatch = canvasId.match(/@(\d+)-canvas/);
                if (canvasMatch) {
                    var canvasNumber = canvasMatch[1];
                    var objectMatch = manifestUrl.match(/iiif\/(?:2\/)?([^\/]+)\//);
                    if (objectMatch) {
                        var objectId = objectMatch[1];
                        var downloadUrl = 'https://dlib2.biblhertz.it/iiif/2/' + objectId + '@' + canvasNumber + '.jp2/full/!4000,4000/0/default.jpg';
                        window.open(downloadUrl, '_blank');
                    }
                }
            }
        });

        document.body.appendChild(downloadButton);

        // Show/hide download button based on view mode
        store.subscribe(function() {
            var state = store.getState();
            var windowIds = Object.keys(state.windows);
            if (windowIds.length > 0) {
                var view = state.windows[windowIds[0]].view;
                downloadButton.style.display = (view === 'single') ? 'block' : 'none';
            }
        });

        // Use mousedown instead of click (Mirador blocks click events)
        document.addEventListener('mousedown', function (e) {
            var target = e.target;
            while (target && target !== document) {
                if (target.tagName === 'A' && target.href) {
                    e.stopPropagation();
                    e.preventDefault();
                    window.open(target.href, target.target || '_blank');
                    return false;
                }
                target = target.parentElement;
            }
        }, true);
    }
</script>
</body>
</html>