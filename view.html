<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirador Viewer</title>
    <script src="https://unpkg.com/mirador@latest/dist/mirador.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #viewer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
        }

        /* Force pointer events on annotation containers and links */
        #viewer a,
        #viewer .mirador-third-party-html,
        #viewer .mirador-third-party-html * {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
    </style>
</head>
<body>
<!-- byte-conform copy of:  https://viewer-f044f0.pages.mpcdf.de -->
<div id="viewer"></div>

<script type="text/javascript">
    var urlParams = new URLSearchParams(window.location.search);
    var manifestUrl = urlParams.get('manifest');
    var itemParam = urlParams.get('item');
    var canvasParam = urlParams.get('canvas');
    var viewParam = urlParams.get('view');

    // ONLY for testing, comment for production!
    itemParam = 'ab816400078'
    
    // Build manifest URL from item parameter if manifest not provided
    // Beware the manifest2 fixed string - this should be changed in the future.
    if (!manifestUrl && itemParam) {
        manifestUrl = 'https://dlib.biblhertz.it/iiif/' + itemParam + '/manifest2.json';
    }

    if (!manifestUrl) {
        document.body.innerHTML = '<h1>Error: No manifest or item provided</h1>';
    } else {
        var windowConfig = {
            loadedManifest: manifestUrl
        };

        // Construct canvas ID if canvas parameter provided
        if (canvasParam) {
            // Extract object ID from manifest URL (e.g., dm5055800)
            var objectMatch = manifestUrl.match(/iiif\/(?:2\/)?([^\/]+)\//);
            if (objectMatch) {
                var objectId = objectMatch[1];
                var paddedCanvas = canvasParam.toString().padStart(4, '0');
                var canvasId = 'https://dlib2.biblhertz.it/iiif/2/' + objectId + '@' + paddedCanvas + '-canvas';
                windowConfig.canvasId = canvasId;
            }
        }

        // Determine sidebar configuration from view parameter
        var sideBarOpen = true;
        var sideBarPanel = 'info'; // default

        if (viewParam) {
            // Valid panels: info, attribution, annotations, canvas
            var validPanels = ['info', 'attribution', 'annotations', 'canvas'];
            if (viewParam === 'none' || viewParam === 'closed') {
                sideBarOpen = false;
            } else if (validPanels.indexOf(viewParam) !== -1) {
                sideBarPanel = viewParam;
            }
        }

        var mirador = Mirador.viewer({
            id: "viewer",
            windows: [windowConfig],
            thumbnailNavigation: {
                defaultPosition: 'far-right'
            },
            workspaceControlPanel: {
                enabled: false,
            },
            window: {
                sideBarOpen: sideBarOpen,
                sideBarPanel: sideBarPanel,
                defaultSidebarPanelWidth: 350,
                allowClose: false,
                allowMaximize: false,
                allowFullscreen: true,
                allowTopMenuButton: true,
                allowWindowSideBar: true,
                panels: {
                    info: true,
                    attribution: true,
                    annotations: true,
                    canvas: true,
                    search: false,
                    layers: false,
                },
                thumbnailNavigation: {
                    height: 130,
                    width: 100
                }
            },
            requests: {
                preprocessors: []
            },
            "osdConfig": {
                "showNavigator": true
            },
            "workspace": {
                "showZoomControls": true
            },
            "windowOptions": {
                "imageToolsEnabled": true,
                "imageToolsOpen": false
            },
            themes: {
                dark: {
                    palette: {
                        type: 'dark',
                        primary: {
                            main: '#8E1B15',
                        },
                        secondary: {
                            main: '#8E1B15',
                        }
                    }
                },
                light: {
                    palette: {
                        type: 'light',
                        primary: {
                            main: '#8E1B15',
                        },
                        secondary: {
                            main: '#8E1B15',
                        }
                    }
                },
            },
        });

// Listen for canvas changes and update URL
        var store = mirador.store;
        var currentCanvasId = null;

        store.subscribe(function () {
            var state = store.getState();
            var windowIds = Object.keys(state.windows);

            if (windowIds.length > 0) {
                var firstWindowId = windowIds[0];
                var canvasId = state.windows[firstWindowId].canvasId;

                // Only update if canvas actually changed
                if (canvasId && canvasId !== currentCanvasId) {
                    currentCanvasId = canvasId;

                    // Extract canvas number from canvas ID
                    var canvasMatch = canvasId.match(/@(\d+)-canvas/);
                    if (canvasMatch) {
                        var canvasNumber = parseInt(canvasMatch[1], 10);

                        // Update URL with new canvas parameter
                        var newUrlParams = new URLSearchParams(window.location.search);
                        newUrlParams.set('canvas', canvasNumber);

                        var newUrl = window.location.pathname + '?' + newUrlParams.toString();
                        window.history.pushState(null, '', newUrl);
                    }
                }
            }
        });

        // Use mousedown instead of click (Mirador blocks click events)
        document.addEventListener('mousedown', function (e) {
            var target = e.target;
            // Walk up the DOM to find if we clicked on or inside a link
            while (target && target !== document) {
                if (target.tagName === 'A' && target.href) {
                    e.stopPropagation();
                    e.preventDefault();
                    window.open(target.href, target.target || '_blank');
                    return false;
                }
                target = target.parentElement;
            }
        }, true); // Capture phase
    }

    // Add custom download button
    var downloadButton = document.createElement('button');
    downloadButton.innerHTML = 'â¬‡';
    downloadButton.style.cssText = 
        'position: fixed; bottom: 25px; right: 160px; z-index: 9999; padding: 10px 15px; background: #8E1B15; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Roboto, sans-serif; font-size: 14px; display: none;';

    downloadButton.addEventListener('click', function() {
        var state = store.getState();
        var windowIds = Object.keys(state.windows);
        if (windowIds.length > 0) {
            var canvasId = state.windows[windowIds[0]].canvasId;
            var canvasMatch = canvasId.match(/@(\d+)-canvas/);
            if (canvasMatch) {
                var canvasNumber = canvasMatch[1];
                var objectMatch = manifestUrl.match(/iiif\/(?:2\/)?([^\/]+)\//);
                if (objectMatch) {
                    var objectId = objectMatch[1];
                    // Construct IIIF image download URL with max 2000px dimension
                    var downloadUrl = 'https://dlib2.biblhertz.it/iiif/2/' + objectId + '@' + canvasNumber + '.jp2/full/!2000,2000/0/default.jpg';
                    window.open(downloadUrl, '_blank');
                }
            }
        }
    });

    document.body.appendChild(downloadButton);

    // Show/hide download button based on view mode
    store.subscribe(function() {
        var state = store.getState();
        var windowIds = Object.keys(state.windows);
        if (windowIds.length > 0) {
            var view = state.windows[windowIds[0]].view;
            // Show button only in single page view
            downloadButton.style.display = (view === 'single') ? 'block' : 'none';
        }
    });
</script>
</body>
</html>